
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>第七步 · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search-pro/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-code/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="内参标定.html" />
    
    
    <link rel="prev" href="cv_bridge的简单使用.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="毕业设计">
            
                <span>
            
                    
                    毕业设计
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="dobot在rviz中显示.html">
            
                <a href="dobot在rviz中显示.html">
            
                    
                    第一步
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="利用Moveit!生成相应配置文件.html">
            
                <a href="利用Moveit!生成相应配置文件.html">
            
                    
                    第二步
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="gazebo与rviz的联合仿真.html">
            
                <a href="gazebo与rviz的联合仿真.html">
            
                    
                    第三步
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="Moveit!控制真实机械臂.html">
            
                <a href="Moveit!控制真实机械臂.html">
            
                    
                    第四步
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="利用c++与python简单控制机械臂.html">
            
                <a href="利用c++与python简单控制机械臂.html">
            
                    
                    第五步
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6" data-path="cv_bridge的简单使用.html">
            
                <a href="cv_bridge的简单使用.html">
            
                    
                    第六步
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.2.7" data-path="手势控制机械臂.html">
            
                <a href="手势控制机械臂.html">
            
                    
                    第七步
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8" data-path="内参标定.html">
            
                <a href="内参标定.html">
            
                    
                    第八步
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.9" data-path="手眼标定.html">
            
                <a href="手眼标定.html">
            
                    
                    第九步
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.10" data-path="darknet_ros.html">
            
                <a href="darknet_ros.html">
            
                    
                    第十步
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >第七步</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="&#x4F7F;&#x7528;&#x624B;&#x52BF;&#x7B80;&#x5355;&#x7684;&#x63A7;&#x5236;&#x673A;&#x68B0;&#x81C2;">&#x4F7F;&#x7528;&#x624B;&#x52BF;&#x7B80;&#x5355;&#x7684;&#x63A7;&#x5236;&#x673A;&#x68B0;&#x81C2;</h1>
<pre><code class="lang-xml">#!/usr/bin/env python3
#coding=utf-8

import os
import sys
import time
import mediapipe as mp
import numpy as np
import threading
import rospy
import cv2
import moveit_commander
from geometry_msgs.msg import PoseStamped
from sensor_msgs.msg import Image
from cv_bridge import CvBridge

# Global variables
img_path = &apos;/home/root1/dobot_ws/src/dobot/images&apos;
img_num = 1
cv_image = np.zeros((480, 640, 3), np.uint8)
mp_drawing = mp.solutions.drawing_utils
mp_hands = mp.solutions.hands
gesture = &quot;none&quot;
gesture_lock = threading.Lock()
bridge = CvBridge()

# Initialize MoveIt
def MoveitJointpose():
    moveit_commander.roscpp_initialize(sys.argv)
    arm = moveit_commander.MoveGroupCommander(&apos;arm&apos;)
    arm.set_goal_joint_tolerance(0.01)
    arm.set_max_velocity_scaling_factor(0.8)
    return arm

# Display FPS on the image
def show_fps(img):
    global fps
    fps_text = &apos;FPS: {:.2f}&apos;.format(fps)
    cv2.putText(img, fps_text, (10, 20), cv2.FONT_HERSHEY_PLAIN, 1.0, (240, 240, 240), 1, cv2.LINE_AA)
    return img

# Calculate distance between two points
def distance(point_1, point_2):
    return np.sqrt((point_1[0] - point_2[0]) ** 2 + (point_1[1] - point_2[1]) ** 2)

# Calculate angle between two vectors
def vector_2d_angle(v1, v2):
    norm_v1_v2 = np.linalg.norm(v1) * np.linalg.norm(v2)
    cos = v1.dot(v2) / (norm_v1_v2)
    sin = np.cross(v1, v2) / (norm_v1_v2)
    angle = np.degrees(np.arctan2(sin, cos))
    return angle

# Convert hand landmarks to image coordinates
def get_hand_landmarks(img_size, landmarks):
    w, h = img_size
    landmarks = [(lm.x * w, lm.y * h) for lm in landmarks]
    return np.array(landmarks)

# Calculate angles of each finger
def hand_angle(landmarks):
    angle_list = []
    angle_ = vector_2d_angle(landmarks[3] - landmarks[4], landmarks[0] - landmarks[2])
    angle_list.append(angle_)
    angle_ = vector_2d_angle(landmarks[0] - landmarks[6], landmarks[7] - landmarks[8])
    angle_list.append(angle_)
    angle_ = vector_2d_angle(landmarks[0] - landmarks[10], landmarks[11] - landmarks[12])
    angle_list.append(angle_)
    angle_ = vector_2d_angle(landmarks[0] - landmarks[14], landmarks[15] - landmarks[16])
    angle_list.append(angle_)
    angle_ = vector_2d_angle(landmarks[0] - landmarks[18], landmarks[19] - landmarks[20])
    angle_list.append(angle_)
    angle_list = [abs(a) for a in angle_list]
    return angle_list

# Determine gesture based on finger angles
def h_gesture(angle_list):
    # Thresholds for angles
    thr_angle = 65.
    thr_angle_thumb = 53.
    thr_angle_s = 49.

    gesture_str = &quot;none&quot;
    if (angle_list[0] &gt; thr_angle_thumb) and (angle_list[1] &gt; thr_angle) and (angle_list[2] &gt; thr_angle) and (angle_list[3] &gt; thr_angle) and (angle_list[4] &gt; thr_angle):
        gesture_str = &quot;fist&quot;
    # Add other gesture conditions here
    return gesture_str

# Image callback function
def callback(data):
    global cv_image
    try:
        cv_image = bridge.imgmsg_to_cv2(data, &quot;bgr8&quot;)
    except CvBridgeError as e:
        print(e)

# Main function for gesture inference
def infer():
    global img_num, cv_image, gesture
    with mp_hands.Hands(min_detection_confidence=0.5, min_tracking_confidence=0.5) as hands:
        while not rospy.is_shutdown():
            image = cv_image.copy()
            results = hands.process(cv2.cvtColor(image, cv2.COLOR_BGR2RGB))
            gesture_str = &quot;none&quot;

            if results.multi_hand_landmarks:
                for hand_landmarks in results.multi_hand_landmarks:
                    mp_drawing.draw_landmarks(image, hand_landmarks, mp_hands.HAND_CONNECTIONS)
                    landmarks = get_hand_landmarks((image.shape[1], image.shape[0]), hand_landmarks.landmark)
                    angle_list = hand_angle(landmarks)
                    gesture_str = h_gesture(angle_list)
                    if gesture_str != &quot;none&quot;:
                        break

            with gesture_lock:
                gesture = gesture_str

            image = show_fps(image)
            cv2.putText(image, gesture_str, (20, 60), cv2.FONT_HERSHEY_SIMPLEX, 1.5, (255, 0, 0), 4)
            cv2.imshow(&apos;demo_gesture&apos;, image)
            key_val = cv2.waitKey(33)
            if key_val == ord(&apos;c&apos;):
                cv2.imwrite(os.path.join(img_path, f&apos;{img_num}.jpg&apos;), image)
                img_num += 1

# Thread for acting based on detected gesture
def infer_act():
    global gesture, arm
    while not rospy.is_shutdown():
        with gesture_lock:
            current_gesture = gesture
        if current_gesture == &quot;one&quot;:
            arm.set_named_target(&apos;Home&apos;)
            arm.go()
            rospy.sleep(1)
        elif current_gesture == &quot;two&quot;:
            arm.set_named_target(&apos;eye_hand&apos;)
            arm.go()
            rospy.sleep(1)
        time.sleep(0.1)

if __name__ == &apos;__main__&apos;:
    rospy.init_node(&quot;demo_gesture&quot;)
    arm = MoveitJointpose()
    rospy.loginfo(&quot;Starting gesture recognition&quot;)

    image_sub = rospy.Subscriber(&quot;/usb_cam/image_raw&quot;, Image, callback)

    try:
        thread = threading.Thread(target=infer)
        thread_act = threading.Thread(target=infer_act)
        thread.start()
        thread_act.start()
        thread.join()
        thread_act.join()
        rospy.spin()
    except KeyboardInterrupt:
        print(&quot;Gesture recognition closed&quot;)
        cv2.destroyAllWindows()
</code></pre>
<p><img src="image-16.png" alt="alt text"></p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="cv_bridge的简单使用.html" class="navigation navigation-prev " aria-label="Previous page: 第六步">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="内参标定.html" class="navigation navigation-next " aria-label="Next page: 第八步">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"第七步","level":"1.2.7","depth":2,"next":{"title":"第八步","level":"1.2.8","depth":2,"path":"内参标定.md","ref":"内参标定.md","articles":[]},"previous":{"title":"第六步","level":"1.2.6","depth":2,"path":"cv_bridge的简单使用.md","ref":"cv_bridge的简单使用.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-lunr","-search","search-pro","code"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"search-pro":{},"code":{"copyButtons":true},"highlight":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{"titleForPage":"页面标题","subTitle":"子标题"},"bookInfo":{"title":"书名","description":"描述","isbn":"图书编号","author":"作者","lang":"zh-cn"},"gitbook":"*"},"file":{"path":"手势控制机械臂.md","mtime":"2024-04-30T07:28:42.053Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2024-04-30T08:01:16.551Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search-pro/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-code/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

